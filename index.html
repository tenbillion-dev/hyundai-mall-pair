<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í˜„ëŒ€ëª° í˜ì–´ ìë™ ë¶„ë°°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-bottom: 15px;
            color: #444;
            font-size: 1.2rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }

        /* ì…ë ¥ ì˜ì—­ */
        .input-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .input-group label {
            font-weight: 600;
            color: #555;
        }
        .input-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* ìƒí’ˆ í…Œì´ë¸” */
        .product-table {
            width: 100%;
            border-collapse: collapse;
        }
        .product-table th, .product-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .product-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .product-table input {
            width: 100px;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .product-table .required {
            background: #fff3cd;
        }
        .product-table input:focus {
            outline: none;
            border-color: #007bff;
        }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #545b62;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        /* ê²°ê³¼ ì˜ì—­ */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }
        .person-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: white;
        }
        .person-card.tier-50 {
            border-color: #28a745;
            background: #d4edda;
        }
        .person-card.tier-40 {
            border-color: #ffc107;
            background: #fff3cd;
        }
        .person-card.tier-30 {
            border-color: #17a2b8;
            background: #d1ecf1;
        }
        .person-card.tier-under {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .person-card.completed {
            border-color: #6c757d;
            background: #e9ecef;
            opacity: 0.7;
        }
        .person-card h3 {
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .progress-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: #6c757d;
            color: white;
            margin-left: 8px;
        }
        .progress-badge.done {
            background: #28a745;
        }
        .person-card .total {
            font-size: 1.1rem;
            font-weight: 700;
        }
        .person-card ul {
            list-style: none;
            font-size: 0.9rem;
        }
        .person-card li {
            padding: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .person-card li:last-child {
            border-bottom: none;
        }
        .person-card li.ordered {
            opacity: 0.5;
            text-decoration: line-through;
        }
        .person-card li.ordered .order-check {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }
        .order-check {
            width: 22px;
            height: 22px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-right: 8px;
        }
        .order-check:hover {
            border-color: #28a745;
        }
        .item-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        .item-name {
            flex: 1;
        }

        /* ì¬ê³  í‘œì‹œ */
        .stock-info {
            color: #666;
            font-size: 0.85rem;
        }

        /* ìš”ì•½ */
        .summary {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .summary-item {
            padding: 10px 20px;
            background: #e9ecef;
            border-radius: 6px;
        }
        .summary-item strong {
            display: block;
            font-size: 1.3rem;
            color: #333;
        }

        /* ì¸ì› ì²´í¬ë°•ìŠ¤ */
        .person-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .person-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .person-checkbox:hover {
            border-color: #007bff;
        }
        .person-checkbox.selected {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }
        .person-checkbox input {
            display: none;
        }

        /* ì‚¬ì… í•­ëª© ìŠ¤íƒ€ì¼ */
        .buy-item {
            background: #e8f5e9 !important;
        }
        .buy-item .item-name {
            color: #2e7d32;
        }
        .section-divider {
            text-align: center;
            color: #666;
            font-size: 0.8rem;
            padding: 8px 0 !important;
            border-bottom: none !important;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ›’ í˜„ëŒ€ëª° í˜ì–´ ìë™ ë¶„ë°°</h1>

    <!-- ì¸ì› ì„ íƒ -->
    <div class="section">
        <h2>ğŸ‘¥ ë¶„ë°° ëŒ€ìƒ ì„ íƒ</h2>
        <div class="person-checkboxes" id="personCheckboxes">
            <!-- JSë¡œ ë™ì  ìƒì„± -->
        </div>
        <div class="btn-group" style="margin-top: 15px;">
            <button class="btn btn-secondary" onclick="selectAllPersons()">ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" onclick="deselectAllPersons()">ì „ì²´ í•´ì œ</button>
        </div>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ ë° ê°€ê²©/ì¬ê³  ì…ë ¥ -->
    <div class="section">
        <h2>ğŸ“¦ ìƒí’ˆ ëª©ë¡ (ê°€ê²©/ì¬ê³  ì…ë ¥)</h2>
        <div class="btn-group" style="margin-bottom: 15px;">
            <button class="btn btn-secondary" onclick="copyStockData()">ğŸ“‹ ì¬ê³  ë°ì´í„° ë³µì‚¬</button>
            <button class="btn btn-secondary" onclick="showPasteModal()">ğŸ“¥ ì¬ê³  ë°ì´í„° ë¶™ì—¬ë„£ê¸°</button>
        </div>
        <table class="product-table">
            <thead>
                <tr>
                    <th>ìƒí’ˆëª…</th>
                    <th>ê°€ê²© (ì›)</th>
                    <th>ìœ„íƒ</th>
                    <th>ì‚¬ì…</th>
                    <th>êµ¬ë¶„</th>
                </tr>
            </thead>
            <tbody id="productTableBody">
                <!-- JSë¡œ ë™ì  ìƒì„± -->
            </tbody>
        </table>
        <div class="btn-group">
            <button class="btn btn-primary" onclick="runDistribution()">ğŸš€ ë¶„ë°° ì‹¤í–‰</button>
            <button class="btn btn-secondary" onclick="saveToLocalStorage()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-secondary" onclick="resetAll()">ğŸ”„ ì´ˆê¸°í™”</button>
            <button class="btn btn-secondary" onclick="clearDistribution()" style="background: #dc3545;">ğŸ—‘ï¸ ë¶„ë°° ì´ˆê¸°í™”</button>
        </div>
    </div>

    <!-- ë¶„ë°° ê²°ê³¼ -->
    <div class="section" id="resultsSection" style="display: none;">
        <h2>ğŸ“Š ë¶„ë°° ê²°ê³¼ <span id="distributionTime" style="font-size: 0.8rem; font-weight: normal; color: #666;"></span></h2>
        <div class="summary" id="summary"></div>
        <div class="results-grid" id="resultsGrid"></div>
    </div>

    <!-- ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ -->
    <div id="pasteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 15px;">ğŸ“¥ ì¬ê³  ë°ì´í„° ë¶™ì—¬ë„£ê¸°</h3>
            <textarea id="pasteArea" style="width: 100%; height: 150px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;" placeholder="ë³µì‚¬í•œ ì¬ê³  ë°ì´í„°ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”..."></textarea>
            <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closePasteModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="applyPastedData()">ì ìš©</button>
            </div>
        </div>
    </div>

    <script>
        // 27ëª… ê³ ì • ì¸ì›
        const persons = [
            'í™˜ì¤€', 'ìˆœë€', 'ìƒë³µ', 'ë¯¼í›„', 'ë„í˜„', 'ì˜ì˜¤', 'ì¬í˜', 'í™˜êµ­', 'ìš°ì„±',
            'ê¸°ë´‰', 'ì¤€í˜„', 'ìµì„ ', 'ì •í˜„', 'ì„±íƒœ', 'ì—°ì‹', 'ìƒí˜„', 'ì„¸ìš©', 'ë¯¼ê·œ',
            'ë³‘í˜„', 'ì„±ë²”', 'íƒœí˜‘', 'ê±´í˜¸', 'ê·œì„±', 'ìˆ˜ë¯¼', 'ì¬í›ˆ', 'ë¯¼ì œ', 'í˜•ìš±'
        ];

        // ìƒí’ˆ ë°ì´í„° (stock: ìœ„íƒ, buyStock: ì‚¬ì…)
        const products = [
            // í•„ìˆ˜ ìƒí’ˆ
            { id: 1, name: 'ë½í† í• ê³¨ë“œ 6í†µ', price: 49735, stock: 5, buyStock: 0, required: true },
            { id: 2, name: 'ë£¨ì§€ì•„ 6ë°•ìŠ¤', price: 61800, stock: 5, buyStock: 0, required: true },
            // ì¼ë°˜ ìƒí’ˆ
            { id: 3, name: 'ì˜ˆë¯¼í•œ ì¥', price: 42600, stock: 0, buyStock: 0, required: false },
            { id: 4, name: 'ë‘”ê°í•œ ì¥', price: 43096, stock: 0, buyStock: 0, required: false },
            { id: 5, name: 'ë©€í‹°ë¹„íƒ€ë¯¼', price: 48890, stock: 0, buyStock: 0, required: false },
            { id: 6, name: 'í”„ë¡œë©”ê°€ ì¥ìš©ì„± ì˜¤ë©”ê°€3', price: 78650, stock: 0, buyStock: 0, required: false },
            { id: 7, name: 'ë¹„ì—ë‚ ì”¬ í”„ë¡œ', price: 147310, stock: 0, buyStock: 0, required: false },
            { id: 8, name: 'ë¹„ì—ë‚ ì”¬ ì¼ë°˜', price: 149660, stock: 0, buyStock: 0, required: false },
            { id: 9, name: 'ë½í† í• ê³¨ë“œ 10í†µ', price: 82110, stock: 0, buyStock: 0, required: false },
            { id: 10, name: 'ë½í† í• ìŠ¬ë¦¼ 6í†µ', price: 92750, stock: 0, buyStock: 0, required: false },
            { id: 11, name: 'ë£¨í…Œì¸ 10í†µ', price: 51978, stock: 0, buyStock: 0, required: false },
            { id: 12, name: 'ë‹¥í„°ë¦° ì´ˆì„ê³„ ì˜¤ë©”ê°€3 12ê°œ', price: 79762, stock: 0, buyStock: 0, required: false },
            { id: 13, name: 'ë‹¥í„°ë¦° í•˜ì´í¼ì…€', price: 136260, stock: 0, buyStock: 0, required: false },
            { id: 14, name: 'ì¢…ê·¼ë‹¹ ë£¨í…Œì¸ ì˜¤ë©”ê°€3', price: 37575, stock: 0, buyStock: 0, required: false },
            { id: 15, name: 'ì´ˆì„ê³„ ì˜¤ë©”ê°€3 3ë°•ìŠ¤', price: 21700, stock: 10, buyStock: 0, required: false },
            { id: 16, name: 'ë½í† í• ë‹¹ì¼€ì–´', price: 50013, stock: 10, buyStock: 0, required: false },
            { id: 17, name: 'ì½˜ë“œë¡œì´ì¹œ ë§¥ìŠ¤ 3ë°•ìŠ¤', price: 48000, stock: 5, buyStock: 0, required: false },
            { id: 18, name: 'ì½˜ë“œë¡œì´ì¹œ ë§¥ìŠ¤ 5ë°•ìŠ¤', price: 71430, stock: 0, buyStock: 0, required: false },
            { id: 19, name: 'ì–‘ë°°ì¶”ì¦™', price: 34700, stock: 0, buyStock: 0, required: false },
            { id: 20, name: 'ì„ë¥˜ 11ê°œ', price: 65203, stock: 0, buyStock: 0, required: false },
            { id: 21, name: 'ì´ë„ˆí”Œë¡œë¼ 3ê°œ', price: 50513, stock: 0, buyStock: 0, required: false },
            { id: 22, name: 'í…Œí¬ 8L', price: 15800, stock: 0, buyStock: 0, required: false },
            { id: 23, name: 'ì½¤ë¹„íƒ€ ë§ˆëˆ„ì¹´ê¿€', price: 59427, stock: 0, buyStock: 0, required: false },
            { id: 24, name: 'ë¹„ë¹„ë© ì½œë¼ê²', price: 86211, stock: 0, buyStock: 0, required: false },
            { id: 25, name: 'ì…€ë ‰ìŠ¤ ë¡œìš°ìŠˆê±° 125ml x48', price: 42600, stock: 0, buyStock: 0, required: false },
            { id: 26, name: 'ì…€ë ‰ìŠ¤ ë¡œìš°ìŠˆê±° 190ml x48', price: 50140, stock: 0, buyStock: 0, required: false },
            { id: 27, name: 'í‚¤ì¹œíƒ€ì˜¬ 140ë§¤', price: 11439, stock: 0, buyStock: 0, required: false },
            { id: 28, name: 'ì •ê´€ì¥ í™ì‚¼ ì—ë¸Œë¦¬íƒ€ì„ í•„ë¦„ 60ë§¤', price: 76870, stock: 0, buyStock: 0, required: false },
            { id: 29, name: 'ëª¨ë˜ì—ë””ì…˜ ë² ìŠ¤íŠ¸', price: 99200, stock: 0, buyStock: 0, required: false },
        ];

        // ëª©í‘œ ê¸ˆì•¡ ë²”ìœ„
        const TARGET_TIERS = [
            { min: 500000, max: 515000, name: '50ë§Œ', class: 'tier-50' },
            { min: 400000, max: 415000, name: '40ë§Œ', class: 'tier-40' },
            { min: 300000, max: 315000, name: '30ë§Œ', class: 'tier-30' },
        ];
        const MIN_ORDER = 50000; // ìµœì†Œ 5ë§Œì›

        // ì´ˆê¸°í™”
        function init() {
            loadFromLocalStorage();
            renderPersonCheckboxes();
            restoreSelectedPersons();
            renderProductTable();
        }

        // ì¸ì› ì²´í¬ë°•ìŠ¤ ë Œë”ë§
        function renderPersonCheckboxes() {
            const container = document.getElementById('personCheckboxes');
            container.innerHTML = '';

            persons.forEach((name, index) => {
                const label = document.createElement('label');
                label.className = 'person-checkbox selected';
                label.innerHTML = `
                    <input type="checkbox" id="person_${index}" checked onchange="togglePerson(this)">
                    <span>${name}</span>
                `;
                container.appendChild(label);
            });
        }

        // ì¸ì› í† ê¸€
        function togglePerson(checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                label.classList.add('selected');
            } else {
                label.classList.remove('selected');
            }
        }

        // ì „ì²´ ì„ íƒ
        function selectAllPersons() {
            persons.forEach((_, index) => {
                const checkbox = document.getElementById(`person_${index}`);
                checkbox.checked = true;
                checkbox.parentElement.classList.add('selected');
            });
        }

        // ì „ì²´ í•´ì œ
        function deselectAllPersons() {
            persons.forEach((_, index) => {
                const checkbox = document.getElementById(`person_${index}`);
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('selected');
            });
        }

        // ì„ íƒëœ ì¸ì› ê°€ì ¸ì˜¤ê¸°
        function getSelectedPersons() {
            const selected = [];
            persons.forEach((name, index) => {
                const checkbox = document.getElementById(`person_${index}`);
                if (checkbox && checkbox.checked) {
                    selected.push(name);
                }
            });
            return selected;
        }

        // ìƒí’ˆ í…Œì´ë¸” ë Œë”ë§
        function renderProductTable() {
            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';

            products.forEach(product => {
                const tr = document.createElement('tr');
                tr.className = product.required ? 'required' : '';
                tr.innerHTML = `
                    <td>${product.name}</td>
                    <td><input type="number" id="price_${product.id}" value="${product.price}" min="0" step="1000" onchange="updateProduct(${product.id})"></td>
                    <td><input type="number" id="stock_${product.id}" value="${product.stock}" min="0" onchange="updateProduct(${product.id})"></td>
                    <td><input type="number" id="buyStock_${product.id}" value="${product.buyStock}" min="0" onchange="updateProduct(${product.id})" style="background: #e8f5e9;"></td>
                    <td>${product.required ? 'â­ í•„ìˆ˜' : 'ì¼ë°˜'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ìƒí’ˆ ì •ë³´ ì—…ë°ì´íŠ¸
        function updateProduct(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                product.price = parseInt(document.getElementById(`price_${id}`).value) || 0;
                product.stock = parseInt(document.getElementById(`stock_${id}`).value) || 0;
                product.buyStock = parseInt(document.getElementById(`buyStock_${id}`).value) || 0;
            }
        }

        // ì•„ì´ë””ë‹¹ 1ê°œ ì œí•œ ìƒí’ˆ (ID ê¸°ì¤€)
        const LIMITED_PRODUCTS = [1, 9, 2, 12]; // ë½í† í• ê³¨ë“œ 6í†µ, ë½í† í• ê³¨ë“œ 10í†µ, ë£¨ì§€ì•„ 6ë°•ìŠ¤, ë‹¥í„°ë¦° ì´ˆì„ê³„ ì˜¤ë©”ê°€3 12ê°œ

        // ë¬´ì œí•œ ìƒí’ˆ (ìµœëŒ€ 10ê°œ) - ID ê¸°ì¤€
        const UNLIMITED_PRODUCTS = [6, 3, 4, 5, 11, 14, 21, 22, 27, 10, 16];
        // í”„ë¡œë©”ê°€ ì¥ìš©ì„± ì˜¤ë©”ê°€3, ì˜ˆë¯¼í•œ ì¥, ë‘”ê°í•œ ì¥, ë©€í‹°ë¹„íƒ€ë¯¼, ë£¨í…Œì¸ 10í†µ, ì¢…ê·¼ë‹¹ ë£¨í…Œì¸ ì˜¤ë©”ê°€3, ì´ë„ˆí”Œë¡œë¼ 3ê°œ, í…Œí¬ 8L, í‚¤ì¹œíƒ€ì˜¬ 140ë§¤, ë½í† í• ìŠ¬ë¦¼ 6í†µ, ë½í† í• ë‹¹ì¼€ì–´

        // í•œ ì•„ì´ë””ì— ëª°ì•„ì£¼ëŠ” ìƒí’ˆ (ê°€ëŠ¥í•œ í•œ ì‚¬ëŒì—ê²Œ ìµœëŒ€ì¹˜ê¹Œì§€)
        const CONSOLIDATE_PRODUCTS = [27, 22]; // í‚¤ì¹œíƒ€ì˜¬ 140ë§¤, í…Œí¬ 8L

        const MAX_SAME_PRODUCT = 3; // ì¼ë°˜ ìƒí’ˆ ìµœëŒ€ êµ¬ë§¤ ê°œìˆ˜
        const MAX_UNLIMITED_PRODUCT = 10; // ë¬´ì œí•œ ìƒí’ˆ ìµœëŒ€ êµ¬ë§¤ ê°œìˆ˜

        // í•œ ì‚¬ëŒì—ê²Œ íŠ¹ì • tierë¥¼ ì±„ìš¸ ìˆ˜ ìˆëŠ”ì§€ ì‹œë®¬ë ˆì´ì…˜
        function tryFillTier(personName, tier, stockRemaining, mustIncludeLactofit10) {
            const result = {
                personName: personName,
                items: [],
                total: 0,
                tier: null,
                productCounts: {}
            };

            const tempStock = { ...stockRemaining };

            // 1ë‹¨ê³„: í•„ìˆ˜ ìƒí’ˆ ë¶„ë°°
            const requiredProducts = products.filter(p => p.required && p.price > 0);
            for (const product of requiredProducts) {
                if (tempStock[product.id] > 0) {
                    result.items.push({ ...product, qty: 1 });
                    result.total += product.price;
                    result.productCounts[product.id] = 1;
                    tempStock[product.id]--;
                }
            }

            // 1-2ë‹¨ê³„: ë½í† í• ê³¨ë“œ 10í†µ í•„ìˆ˜ ë¶„ë°° (ìš”ì²­ëœ ê²½ìš°)
            if (mustIncludeLactofit10) {
                const lactofit10 = products.find(p => p.id === 9);
                if (lactofit10 && lactofit10.price > 0 && tempStock[9] > 0 && !result.productCounts[9]) {
                    result.items.push({ ...lactofit10, qty: 1 });
                    result.total += lactofit10.price;
                    result.productCounts[9] = 1;
                    tempStock[9]--;
                } else if (mustIncludeLactofit10) {
                    return null; // 10í†µ í•„ìˆ˜ì¸ë° ì¬ê³  ì—†ìœ¼ë©´ ì‹¤íŒ¨
                }
            }

            const targetMin = tier.min;
            const targetMax = tier.max;

            // ì´ë¯¸ ëª©í‘œ ë²”ìœ„ ë‚´ë©´ ì„±ê³µ
            if (result.total >= targetMin && result.total <= targetMax) {
                result.tier = tier;
                return { result, usedStock: tempStock };
            }

            // ëª©í‘œ ì´ˆê³¼ë©´ ì‹¤íŒ¨
            if (result.total > targetMax) {
                return null;
            }

            // ëª©í‘œ ì±„ìš°ê¸° ì‹œë„
            let improved = true;
            while (improved && result.total < targetMin) {
                improved = false;

                const availableProducts = products
                    .filter(p => {
                        if (p.price <= 0 || tempStock[p.id] <= 0) return false;
                        const currentQty = result.productCounts[p.id] || 0;

                        if (LIMITED_PRODUCTS.includes(p.id)) return currentQty < 1;
                        if (UNLIMITED_PRODUCTS.includes(p.id)) return currentQty < MAX_UNLIMITED_PRODUCT;
                        return currentQty < MAX_SAME_PRODUCT;
                    })
                    .sort((a, b) => b.price - a.price);

                for (const product of availableProducts) {
                    const newTotal = result.total + product.price;

                    if (newTotal <= targetMax) {
                        const existingItem = result.items.find(item => item.id === product.id);
                        if (existingItem) {
                            existingItem.qty++;
                        } else {
                            result.items.push({ ...product, qty: 1 });
                        }
                        result.total = newTotal;
                        result.productCounts[product.id] = (result.productCounts[product.id] || 0) + 1;
                        tempStock[product.id]--;
                        improved = true;

                        if (result.total >= targetMin && result.total <= targetMax) {
                            result.tier = tier;
                            return { result, usedStock: tempStock };
                        }
                        break;
                    }
                }
            }

            // ëª©í‘œ ë‹¬ì„± ì²´í¬
            if (result.total >= targetMin && result.total <= targetMax) {
                result.tier = tier;
                return { result, usedStock: tempStock };
            }

            return null; // ì‹¤íŒ¨
        }

        // ë¶„ë°° ì‹¤í–‰ - í•„ìˆ˜ ìƒí’ˆ ì¬ê³  ê¸°ì¤€ìœ¼ë¡œ ì‚¬ìš© ì•„ì´ë”” ìˆ˜ ê²°ì •
        function runDistribution() {
            products.forEach(p => updateProduct(p.id));

            const selectedPersons = getSelectedPersons();
            if (selectedPersons.length === 0) {
                alert('ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì¬ê³  ë³µì‚¬ (ìœ„íƒ + ì‚¬ì… = ì´ ì¬ê³ )
            let stockRemaining = {};
            let buyStockInfo = {}; // ì‚¬ì… ì¬ê³  ì¶”ì ìš©
            products.forEach(p => {
                stockRemaining[p.id] = p.stock + p.buyStock; // ì´ ì¬ê³ 
                buyStockInfo[p.id] = p.buyStock; // ì‚¬ì… ê°œìˆ˜ ì €ì¥
            });

            // í•„ìˆ˜ ìƒí’ˆ 3ì¢… ì¬ê³  í™•ì¸ (ì´ ì¬ê³  ê¸°ì¤€)
            // ë½í† í• ê³¨ë“œ 6í†µ(1), ë£¨ì§€ì•„ 6ë°•ìŠ¤(2), ë½í† í• ê³¨ë“œ 10í†µ(9)
            const lactofit6Stock = stockRemaining[1] || 0;   // ë½í† í• ê³¨ë“œ 6í†µ
            const luziaStock = stockRemaining[2] || 0;       // ë£¨ì§€ì•„ 6ë°•ìŠ¤
            const lactofit10Stock = stockRemaining[9] || 0;  // ë½í† í• ê³¨ë“œ 10í†µ

            // í•„ìˆ˜ ìƒí’ˆ ì¤‘ ê°€ì¥ ë§ì€ ì¬ê³  = ì‚¬ìš©í•  ì•„ì´ë”” ìˆ˜
            const maxRequiredStock = Math.max(lactofit6Stock, luziaStock, lactofit10Stock);

            if (maxRequiredStock === 0) {
                alert('í•„ìˆ˜ ìƒí’ˆ(ë½í† í• 6í†µ, ë£¨ì§€ì•„, ë½í† í• 10í†µ) ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì‚¬ìš©í•  ì•„ì´ë”” ìˆ˜ = min(ì„ íƒëœ ì¸ì›, í•„ìˆ˜ ìƒí’ˆ ìµœëŒ€ ì¬ê³ )
            const targetPersons = Math.min(selectedPersons.length, maxRequiredStock);

            console.log(`=== ë¶„ë°° ì‹œì‘ ===`);
            console.log(`í•„ìˆ˜ ìƒí’ˆ ì¬ê³ : ë½ê³¨6í†µ=${lactofit6Stock}, ë£¨ì§€ì•„=${luziaStock}, ë½ê³¨10í†µ=${lactofit10Stock}`);
            console.log(`ì‚¬ìš© ì•„ì´ë”” ìˆ˜: ${targetPersons}ëª… (max ê¸°ì¤€)`);

            // ê° ì•„ì´ë””ì— í•„ìˆ˜ ìƒí’ˆ ìš°ì„  ë¶„ë°° ê³„íš
            // 1. ê° ì•„ì´ë””ê°€ ë°›ì„ í•„ìˆ˜ ìƒí’ˆ ê²°ì • (ì¬ê³  ìˆëŠ” ë§Œí¼ë§Œ)
            const personAssignments = [];

            for (let i = 0; i < targetPersons; i++) {
                const personName = selectedPersons[i];
                const assignment = {
                    personName: personName,
                    lactofit6: i < lactofit6Stock,    // ì¬ê³  ìˆìœ¼ë©´ 1ê°œ
                    luzia: i < luziaStock,            // ì¬ê³  ìˆìœ¼ë©´ 1ê°œ
                    lactofit10: i < lactofit10Stock,  // ì¬ê³  ìˆìœ¼ë©´ 1ê°œ
                };
                personAssignments.push(assignment);
            }

            // 2. í•„ìˆ˜ ìƒí’ˆ ë¶„ë°° í›„ ë‚¨ì€ ì¬ê³  ê³„ì‚°
            let workingStock = { ...stockRemaining };
            workingStock[1] = Math.max(0, lactofit6Stock - targetPersons);   // ë½ê³¨6í†µ ë‚¨ì€ ì¬ê³ 
            workingStock[2] = Math.max(0, luziaStock - targetPersons);       // ë£¨ì§€ì•„ ë‚¨ì€ ì¬ê³ 
            workingStock[9] = Math.max(0, lactofit10Stock - targetPersons);  // ë½ê³¨10í†µ ë‚¨ì€ ì¬ê³ 

            // 3. ê° ì•„ì´ë””ë³„ ê¸°ë³¸ ê¸ˆì•¡ ê³„ì‚° (í•„ìˆ˜ ìƒí’ˆ í•©ê³„)
            const lactofit6Price = products.find(p => p.id === 1)?.price || 0;
            const luziaPrice = products.find(p => p.id === 2)?.price || 0;
            const lactofit10Price = products.find(p => p.id === 9)?.price || 0;

            personAssignments.forEach((assignment, i) => {
                let baseTotal = 0;
                if (assignment.lactofit6) baseTotal += lactofit6Price;
                if (assignment.luzia) baseTotal += luziaPrice;
                if (assignment.lactofit10) baseTotal += lactofit10Price;
                assignment.baseTotal = baseTotal;
                console.log(`${assignment.personName}: í•„ìˆ˜í’ˆ í•©ê³„ ${baseTotal.toLocaleString()}ì›`);
            });

            // 4. ê° ì•„ì´ë””ì—ê²Œ tier ì±„ìš°ê¸° (30ë§Œ â†’ 40ë§Œ â†’ 50ë§Œ ìˆœìœ¼ë¡œ ë³´ìˆ˜ì  ì ‘ê·¼)
            const finalResults = [];
            let currentStock = { ...workingStock };

            for (let i = 0; i < targetPersons; i++) {
                const assignment = personAssignments[i];
                const personName = assignment.personName;
                const remainingPersons = targetPersons - i - 1;

                // ê¸°ë³¸ ê²°ê³¼ (í•„ìˆ˜ ìƒí’ˆë§Œ)
                const result = {
                    personName: personName,
                    items: [],
                    total: 0,
                    tier: null,
                    productCounts: {}
                };

                // í•„ìˆ˜ ìƒí’ˆ ì¶”ê°€
                if (assignment.lactofit6) {
                    const product = products.find(p => p.id === 1);
                    result.items.push({ ...product, qty: 1 });
                    result.total += product.price;
                    result.productCounts[1] = 1;
                }
                if (assignment.luzia) {
                    const product = products.find(p => p.id === 2);
                    result.items.push({ ...product, qty: 1 });
                    result.total += product.price;
                    result.productCounts[2] = 1;
                }
                if (assignment.lactofit10) {
                    const product = products.find(p => p.id === 9);
                    result.items.push({ ...product, qty: 1 });
                    result.total += product.price;
                    result.productCounts[9] = 1;
                }

                // 1ë‹¨ê³„: 30ë§Œì› ë‹¬ì„± ì‹œë„ (ëª¨ë“  ì•„ì´ë””ê°€ ìµœì†Œ tier ë‹¬ì„± ìš°ì„ )
                const tier30Result = tryFillTierMaximize(result, TARGET_TIERS[2], currentStock);
                if (tier30Result) {
                    finalResults.push(tier30Result.result);
                    currentStock = tier30Result.usedStock;
                    console.log(`${personName}: 30ë§Œ ë‹¬ì„± (${tier30Result.result.total.toLocaleString()}ì›)`);
                } else {
                    // 30ë§Œì›ë„ ì•ˆ ë˜ë©´ ë¯¸ë‹¬
                    result.tier = { name: 'ë¯¸ë‹¬', class: 'tier-under' };
                    finalResults.push(result);
                    console.log(`${personName}: ë¯¸ë‹¬ (${result.total.toLocaleString()}ì›)`);
                }
            }

            // 2ë‹¨ê³„: ë‚¨ì€ ì¬ê³ ë¡œ tier ì—…ê·¸ë ˆì´ë“œ ì‹œë„ (30ë§Œ â†’ 40ë§Œ â†’ 50ë§Œ)
            currentStock = upgradeTiers(finalResults, currentStock);

            // ì‚¬ì… í•­ëª© ê³„ì‚° (ê° ìƒí’ˆë³„ë¡œ ë’¤ì—ì„œë¶€í„° ì‚¬ì… ê°œìˆ˜ë§Œí¼ ì‚¬ì…ìœ¼ë¡œ í‘œì‹œ)
            const buyAssignments = calculateBuyAssignments(finalResults, buyStockInfo);

            displayResults(finalResults, currentStock, buyAssignments);

            // ë¶„ë°° ê²°ê³¼ ì €ì¥
            saveDistributionResults(finalResults, currentStock, buyAssignments);

            // ìœ„íƒ/ì‚¬ì… ì¬ê³  ë°ì´í„°ë„ ìë™ ì €ì¥
            saveToLocalStorageSilent();
        }

        // 2ë‹¨ê³„: ë‚¨ì€ ì¬ê³ ë¡œ tier ì—…ê·¸ë ˆì´ë“œ (30ë§Œâ†’40ë§Œâ†’50ë§Œ)
        function upgradeTiers(results, stockRemaining) {
            let currentStock = { ...stockRemaining };
            let upgraded = true;

            while (upgraded) {
                upgraded = false;

                // 30ë§Œì›ëŒ€ì¸ ì•„ì´ë”” ì°¾ì•„ì„œ 40ë§Œì›ëŒ€ë¡œ ì—…ê·¸ë ˆì´ë“œ ì‹œë„
                for (let i = 0; i < results.length; i++) {
                    const result = results[i];
                    if (result.tier?.name === '30ë§Œ') {
                        const upgradeResult = tryUpgradeToTier(result, TARGET_TIERS[1], currentStock); // 40ë§Œ
                        if (upgradeResult) {
                            results[i] = upgradeResult.result;
                            currentStock = upgradeResult.usedStock;
                            upgraded = true;
                            console.log(`${result.personName}: 30ë§Œ â†’ 40ë§Œ ì—…ê·¸ë ˆì´ë“œ`);
                            break;
                        }
                    }
                }

                // 40ë§Œì›ëŒ€ì¸ ì•„ì´ë”” ì°¾ì•„ì„œ 50ë§Œì›ëŒ€ë¡œ ì—…ê·¸ë ˆì´ë“œ ì‹œë„
                if (!upgraded) {
                    for (let i = 0; i < results.length; i++) {
                        const result = results[i];
                        if (result.tier?.name === '40ë§Œ') {
                            const upgradeResult = tryUpgradeToTier(result, TARGET_TIERS[0], currentStock); // 50ë§Œ
                            if (upgradeResult) {
                                results[i] = upgradeResult.result;
                                currentStock = upgradeResult.usedStock;
                                upgraded = true;
                                console.log(`${result.personName}: 40ë§Œ â†’ 50ë§Œ ì—…ê·¸ë ˆì´ë“œ`);
                                break;
                            }
                        }
                    }
                }

                // 30ë§Œì›ëŒ€ë¥¼ ë°”ë¡œ 50ë§Œì›ëŒ€ë¡œ ì—…ê·¸ë ˆì´ë“œ ì‹œë„ (40ë§Œ ê±´ë„ˆë›°ê¸°)
                if (!upgraded) {
                    for (let i = 0; i < results.length; i++) {
                        const result = results[i];
                        if (result.tier?.name === '30ë§Œ') {
                            const upgradeResult = tryUpgradeToTier(result, TARGET_TIERS[0], currentStock); // 50ë§Œ
                            if (upgradeResult) {
                                results[i] = upgradeResult.result;
                                currentStock = upgradeResult.usedStock;
                                upgraded = true;
                                console.log(`${result.personName}: 30ë§Œ â†’ 50ë§Œ ì—…ê·¸ë ˆì´ë“œ`);
                                break;
                            }
                        }
                    }
                }
            }

            return currentStock;
        }

        // tier ì—…ê·¸ë ˆì´ë“œ ì‹œë„ (í˜„ì¬ ì•„ì´í…œì— ì¶”ê°€í•´ì„œ ìƒìœ„ tier ë‹¬ì„±)
        function tryUpgradeToTier(currentResult, targetTier, stockRemaining) {
            const result = {
                personName: currentResult.personName,
                items: currentResult.items.map(item => ({ ...item })),
                total: currentResult.total,
                tier: null,
                productCounts: { ...currentResult.productCounts }
            };

            const tempStock = { ...stockRemaining };
            const targetMin = targetTier.min;
            const targetMax = targetTier.max;

            // ì´ë¯¸ ëª©í‘œ ì´ˆê³¼ë©´ ë¶ˆê°€
            if (result.total > targetMax) {
                return null;
            }

            // ëª©í‘œ ì±„ìš°ê¸° ì‹œë„
            let improved = true;
            while (improved && result.total < targetMin) {
                improved = false;

                const availableProducts = products
                    .filter(p => {
                        if (p.required) return false;
                        if (p.price <= 0 || tempStock[p.id] <= 0) return false;
                        const currentQty = result.productCounts[p.id] || 0;

                        if (LIMITED_PRODUCTS.includes(p.id)) return currentQty < 1;
                        if (UNLIMITED_PRODUCTS.includes(p.id)) return currentQty < MAX_UNLIMITED_PRODUCT;
                        return currentQty < MAX_SAME_PRODUCT;
                    })
                    .sort((a, b) => {
                        // ëª°ì•„ì£¼ê¸° ìƒí’ˆ ìš°ì„ 
                        const aConsolidate = CONSOLIDATE_PRODUCTS.includes(a.id) && (result.productCounts[a.id] || 0) > 0;
                        const bConsolidate = CONSOLIDATE_PRODUCTS.includes(b.id) && (result.productCounts[b.id] || 0) > 0;
                        if (aConsolidate && !bConsolidate) return -1;
                        if (!aConsolidate && bConsolidate) return 1;
                        return b.price - a.price;
                    });

                for (const product of availableProducts) {
                    const newTotal = result.total + product.price;

                    if (newTotal <= targetMax) {
                        const existingItem = result.items.find(item => item.id === product.id);
                        if (existingItem) {
                            existingItem.qty++;
                        } else {
                            result.items.push({ ...product, qty: 1 });
                        }
                        result.total = newTotal;
                        result.productCounts[product.id] = (result.productCounts[product.id] || 0) + 1;
                        tempStock[product.id]--;
                        improved = true;

                        if (result.total >= targetMin && result.total <= targetMax) {
                            result.tier = targetTier;
                            return { result, usedStock: tempStock };
                        }
                        break;
                    }
                }
            }

            // ëª©í‘œ ë‹¬ì„± ì²´í¬
            if (result.total >= targetMin && result.total <= targetMax) {
                result.tier = targetTier;
                return { result, usedStock: tempStock };
            }

            return null;
        }

        // ì¬ê³  ì†Œì§„ ìµœëŒ€í™” - tier ì±„ìš°ê¸° (ë‚¨ì€ ì¸ì› ì²´í¬ ì—†ì´, ìµœëŒ€í•œ ì±„ì›€)
        function tryFillTierMaximize(baseResult, tier, stockRemaining) {
            const result = {
                personName: baseResult.personName,
                items: baseResult.items.map(item => ({ ...item })),
                total: baseResult.total,
                tier: null,
                productCounts: { ...baseResult.productCounts }
            };

            const tempStock = { ...stockRemaining };
            const targetMin = tier.min;
            const targetMax = tier.max;

            // ì´ë¯¸ ëª©í‘œ ë²”ìœ„ ë‚´ë©´ ì„±ê³µ
            if (result.total >= targetMin && result.total <= targetMax) {
                result.tier = tier;
                return { result, usedStock: tempStock };
            }

            // ëª©í‘œ ì´ˆê³¼ë©´ ì‹¤íŒ¨
            if (result.total > targetMax) {
                return null;
            }

            // ëª©í‘œ ì±„ìš°ê¸° ì‹œë„
            let improved = true;
            while (improved && result.total < targetMin) {
                improved = false;

                const availableProducts = products
                    .filter(p => {
                        if (p.required) return false;
                        if (p.price <= 0 || tempStock[p.id] <= 0) return false;
                        const currentQty = result.productCounts[p.id] || 0;

                        if (LIMITED_PRODUCTS.includes(p.id)) return currentQty < 1;
                        if (UNLIMITED_PRODUCTS.includes(p.id)) return currentQty < MAX_UNLIMITED_PRODUCT;
                        return currentQty < MAX_SAME_PRODUCT;
                    })
                    .sort((a, b) => {
                        // ëª°ì•„ì£¼ê¸° ìƒí’ˆ ìš°ì„  (í‚¤ì¹œíƒ€ì˜¬ ë“±) - ì´ë¯¸ í•´ë‹¹ ìƒí’ˆì„ ê°€ì§€ê³  ìˆìœ¼ë©´ ë” ìš°ì„ 
                        const aConsolidate = CONSOLIDATE_PRODUCTS.includes(a.id) && (result.productCounts[a.id] || 0) > 0;
                        const bConsolidate = CONSOLIDATE_PRODUCTS.includes(b.id) && (result.productCounts[b.id] || 0) > 0;
                        if (aConsolidate && !bConsolidate) return -1;
                        if (!aConsolidate && bConsolidate) return 1;
                        return b.price - a.price;
                    });

                for (const product of availableProducts) {
                    const newTotal = result.total + product.price;

                    if (newTotal <= targetMax) {
                        const existingItem = result.items.find(item => item.id === product.id);
                        if (existingItem) {
                            existingItem.qty++;
                        } else {
                            result.items.push({ ...product, qty: 1 });
                        }
                        result.total = newTotal;
                        result.productCounts[product.id] = (result.productCounts[product.id] || 0) + 1;
                        tempStock[product.id]--;
                        improved = true;

                        if (result.total >= targetMin && result.total <= targetMax) {
                            result.tier = tier;
                            return { result, usedStock: tempStock };
                        }
                        break;
                    }
                }
            }

            // ëª©í‘œ ë‹¬ì„± ì²´í¬
            if (result.total >= targetMin && result.total <= targetMax) {
                result.tier = tier;
                return { result, usedStock: tempStock };
            }

            return null;
        }

        // ì‚¬ì… í•­ëª© ê³„ì‚° - ìƒí’ˆë³„ë¡œ 5ë§Œì› ì´ìƒ ë˜ë„ë¡ í•œ ì•„ì´ë””ì— ëª°ì•„ì£¼ê¸°
        const MIN_BUY_AMOUNT = 50000; // ì‚¬ì… ìµœì†Œ ê¸ˆì•¡

        function calculateBuyAssignments(results, buyStockInfo) {
            // 1. ê° ì•„ì´ë””ê°€ ì–´ë–¤ ìƒí’ˆì„ ëª‡ ê°œ ê°€ì§€ê³  ìˆëŠ”ì§€ ë§¤í•‘
            const personProducts = {}; // { personIndex: { productId: qty, ... } }

            results.forEach((result, personIndex) => {
                personProducts[personIndex] = {};
                result.items.forEach(item => {
                    personProducts[personIndex][item.id] = item.qty;
                });
            });

            // 2. ì‚¬ì… ë°°ì • ê²°ê³¼
            const buyAssignments = {}; // { personIndex: { productId: buyQty, ... } }

            // 3. ë‚¨ì€ ì‚¬ì… ì¬ê³  ë³µì‚¬
            const remainingBuyStock = { ...buyStockInfo };

            // 4. ìƒí’ˆë³„ë¡œ ì²˜ë¦¬
            const productsWithBuyStock = products
                .filter(p => remainingBuyStock[p.id] > 0)
                .sort((a, b) => b.price - a.price);

            for (const product of productsWithBuyStock) {
                const productId = product.id;
                let buyStockLeft = remainingBuyStock[productId];
                if (buyStockLeft <= 0) continue;

                // ì´ ìƒí’ˆ 1ê°œê°€ 5ë§Œì› ì´ìƒì¸ì§€ í™•ì¸
                const needsGrouping = product.price < MIN_BUY_AMOUNT;
                // 5ë§Œì› ì±„ìš°ë ¤ë©´ ëª‡ ê°œ í•„ìš”í•œì§€
                const minQtyFor50k = needsGrouping ? Math.ceil(MIN_BUY_AMOUNT / product.price) : 1;

                // ì´ ìƒí’ˆì„ ê°€ì§„ ì•„ì´ë””ë“¤ ì°¾ê¸° (ë’¤ì—ì„œë¶€í„°)
                const personsWithProduct = [];
                results.forEach((result, personIndex) => {
                    const qty = personProducts[personIndex][productId] || 0;
                    if (qty > 0) {
                        personsWithProduct.push({ personIndex, qty });
                    }
                });
                personsWithProduct.reverse();

                // 5ë§Œì› ë¯¸ë§Œ ìƒí’ˆ: í•œ ì•„ì´ë””ì— 5ë§Œì› ì´ìƒ ë˜ë„ë¡ ëª°ì•„ì£¼ê¸°
                if (needsGrouping) {
                    for (const { personIndex, qty } of personsWithProduct) {
                        if (buyStockLeft <= 0) break;

                        const alreadyAssigned = buyAssignments[personIndex]?.[productId] || 0;
                        const canAssign = Math.min(qty - alreadyAssigned, buyStockLeft);

                        // 5ë§Œì› ì±„ìš¸ ìˆ˜ ìˆëŠ” ê°œìˆ˜ê°€ ìˆì„ ë•Œë§Œ ë°°ì •
                        if (canAssign >= minQtyFor50k) {
                            // 5ë§Œì› ì´ìƒ ë˜ëŠ” ìµœì†Œ ê°œìˆ˜ë§Œ ë°°ì • (ë‚˜ë¨¸ì§€ëŠ” ë‹¤ë¥¸ ì•„ì´ë””ì—)
                            const toAssign = minQtyFor50k;

                            if (!buyAssignments[personIndex]) {
                                buyAssignments[personIndex] = {};
                            }
                            buyAssignments[personIndex][productId] = toAssign;
                            buyStockLeft -= toAssign;
                        }
                    }

                    // ë‚¨ì€ ì‚¬ì… ì¬ê³  ì²˜ë¦¬ (5ë§Œì› ëª» ì±„ìš°ë”ë¼ë„ ë°°ì •)
                    if (buyStockLeft > 0) {
                        for (const { personIndex, qty } of personsWithProduct) {
                            if (buyStockLeft <= 0) break;

                            const alreadyAssigned = buyAssignments[personIndex]?.[productId] || 0;
                            const canAssign = Math.min(qty - alreadyAssigned, buyStockLeft);

                            if (canAssign > 0) {
                                if (!buyAssignments[personIndex]) {
                                    buyAssignments[personIndex] = {};
                                }
                                buyAssignments[personIndex][productId] = (buyAssignments[personIndex][productId] || 0) + canAssign;
                                buyStockLeft -= canAssign;
                            }
                        }
                    }
                } else {
                    // 5ë§Œì› ì´ìƒ ìƒí’ˆ: ê¸°ì¡´ì²˜ëŸ¼ ë’¤ì—ì„œë¶€í„° 1ê°œì”© ë°°ì •
                    for (const { personIndex, qty } of personsWithProduct) {
                        if (buyStockLeft <= 0) break;

                        const alreadyAssigned = buyAssignments[personIndex]?.[productId] || 0;
                        const canAssign = Math.min(qty - alreadyAssigned, buyStockLeft);

                        if (canAssign > 0) {
                            if (!buyAssignments[personIndex]) {
                                buyAssignments[personIndex] = {};
                            }
                            buyAssignments[personIndex][productId] = canAssign;
                            buyStockLeft -= canAssign;
                        }
                    }
                }
            }

            return buyAssignments;
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResults(results, stockRemaining, buyAssignments = {}) {
            const section = document.getElementById('resultsSection');
            section.style.display = 'block';

            // ìš”ì•½
            const summary = document.getElementById('summary');
            const tier50 = results.filter(r => r.tier?.name === '50ë§Œ').length;
            const tier40 = results.filter(r => r.tier?.name === '40ë§Œ').length;
            const tier30 = results.filter(r => r.tier?.name === '30ë§Œ').length;
            const tierUnder = results.filter(r => r.tier?.name === 'ë¯¸ë‹¬' || r.tier?.name === '5ë§Œ ë¯¸ë§Œ').length;
            const totalAmount = results.reduce((sum, r) => sum + r.total, 0);

            summary.innerHTML = `
                <div class="summary-item"><strong>${tier50}ëª…</strong>50ë§Œì›ëŒ€</div>
                <div class="summary-item"><strong>${tier40}ëª…</strong>40ë§Œì›ëŒ€</div>
                <div class="summary-item"><strong>${tier30}ëª…</strong>30ë§Œì›ëŒ€</div>
                <div class="summary-item"><strong>${tierUnder}ëª…</strong>ë¯¸ë‹¬</div>
                <div class="summary-item"><strong>${totalAmount.toLocaleString()}ì›</strong>ì´ ì£¼ë¬¸ê¸ˆì•¡</div>
            `;

            // ê°œì¸ë³„ ê²°ê³¼
            const grid = document.getElementById('resultsGrid');
            grid.innerHTML = '';

            results.forEach((result, personIndex) => {
                const card = document.createElement('div');
                card.className = `person-card ${result.tier?.class || ''}`;
                card.id = `card_${personIndex}`;

                // ì´ ì‚¬ëŒì˜ ì‚¬ì… í•­ëª© ê°€ì ¸ì˜¤ê¸°
                const personBuyItems = buyAssignments[personIndex] || {};
                const hasBuyItems = Object.keys(personBuyItems).length > 0;

                // ìœ„íƒ í•­ëª©ê³¼ ì‚¬ì… í•­ëª© ë¶„ë¦¬
                let consignmentItems = []; // ìœ„íƒ
                let buyItems = []; // ì‚¬ì…

                result.items.forEach(item => {
                    const buyQty = personBuyItems[item.id] || 0;
                    const consignmentQty = item.qty - buyQty;

                    if (consignmentQty > 0) {
                        consignmentItems.push({ ...item, qty: consignmentQty });
                    }
                    if (buyQty > 0) {
                        buyItems.push({ ...item, qty: buyQty });
                    }
                });

                // ì´ ì²´í¬ë°•ìŠ¤ ê°œìˆ˜ (ìœ„íƒ + ì‚¬ì…)
                const totalCheckboxCount = consignmentItems.length + buyItems.length;
                card.dataset.itemCount = totalCheckboxCount;

                // ìœ„íƒ í•­ëª© HTML
                let itemIndex = 0;
                const consignmentHtml = consignmentItems.map((item) => {
                    const itemId = `order_${personIndex}_${itemIndex++}`;
                    return `<li id="${itemId}_li">
                        <div class="item-info">
                            <div class="order-check" id="${itemId}" onclick="toggleOrder(${personIndex}, '${itemId}')" title="ì£¼ë¬¸ ì™„ë£Œ ì²´í¬"></div>
                            <span class="item-name">${item.name}${item.qty > 1 ? ` x${item.qty}` : ''}</span>
                        </div>
                        <span>${(item.price * item.qty).toLocaleString()}ì›</span>
                    </li>`;
                }).join('');

                // ì‚¬ì… í•­ëª© HTML
                const buyHtml = buyItems.map((item) => {
                    const itemId = `order_${personIndex}_${itemIndex++}`;
                    return `<li id="${itemId}_li" class="buy-item">
                        <div class="item-info">
                            <div class="order-check" id="${itemId}" onclick="toggleOrder(${personIndex}, '${itemId}')" title="ì‚¬ì… ì£¼ë¬¸ ì™„ë£Œ ì²´í¬"></div>
                            <span class="item-name">${item.name}${item.qty > 1 ? ` x${item.qty}` : ''}</span>
                        </div>
                        <span>${(item.price * item.qty).toLocaleString()}ì›</span>
                    </li>`;
                }).join('');

                // êµ¬ë¶„ì„  ë° ì‚¬ì… ì„¹ì…˜
                const buySection = hasBuyItems ? `
                    <li class="section-divider">â”€â”€â”€â”€â”€â”€ ğŸ“¦ ì‚¬ì… â”€â”€â”€â”€â”€â”€</li>
                    ${buyHtml}
                ` : '';

                card.innerHTML = `
                    <h3>
                        <span>ğŸ‘¤ ${result.personName}<span class="progress-badge" id="badge_${personIndex}">0/${totalCheckboxCount}</span></span>
                        <span class="total">${result.total.toLocaleString()}ì›</span>
                    </h3>
                    <div style="margin-bottom: 8px; font-weight: 600; color: ${result.tier?.class === 'tier-under' ? '#dc3545' : '#28a745'}">
                        ${result.tier?.name || '-'}
                    </div>
                    <ul>${consignmentHtml || ''}${buySection || (consignmentHtml ? '' : '<li>ë°°ì •ëœ ìƒí’ˆ ì—†ìŒ</li>')}</ul>
                `;
                grid.appendChild(card);
            });

            // ë‚¨ì€ ì¬ê³  í‘œì‹œ
            const remainingStock = products
                .filter(p => stockRemaining[p.id] > 0)
                .map(p => `${p.name}: ${stockRemaining[p.id]}ê°œ`)
                .join(', ');

            if (remainingStock) {
                const stockDiv = document.createElement('div');
                stockDiv.className = 'stock-info';
                stockDiv.style.marginTop = '20px';
                stockDiv.innerHTML = `<strong>ğŸ“¦ ë‚¨ì€ ì¬ê³ :</strong> ${remainingStock}`;
                grid.appendChild(stockDiv);
            }
        }

        // localStorage ì €ì¥
        function saveToLocalStorage() {
            products.forEach(p => updateProduct(p.id));
            const selectedPersons = getSelectedPersons();
            const data = {
                products: products.map(p => ({ id: p.id, price: p.price, stock: p.stock, buyStock: p.buyStock })),
                selectedPersons: selectedPersons
            };
            localStorage.setItem('hyundaimall_fair', JSON.stringify(data));
            alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // localStorage ë¶ˆëŸ¬ì˜¤ê¸°
        function loadFromLocalStorage() {
            const saved = localStorage.getItem('hyundaimall_fair');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    if (data.products) {
                        data.products.forEach(savedProduct => {
                            const product = products.find(p => p.id === savedProduct.id);
                            if (product) {
                                product.price = savedProduct.price || 0;
                                product.stock = savedProduct.stock || 0;
                                product.buyStock = savedProduct.buyStock || 0;
                            }
                        });
                    }
                    // ì„ íƒëœ ì¸ì› ë³µì› (renderPersonCheckboxes í›„ì— ì ìš©)
                    if (data.selectedPersons) {
                        window.savedSelectedPersons = data.selectedPersons;
                    }
                } catch (e) {
                    console.error('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', e);
                }
            }
        }

        // ì €ì¥ëœ ì¸ì› ì„ íƒ ë³µì›
        function restoreSelectedPersons() {
            if (window.savedSelectedPersons) {
                persons.forEach((name, index) => {
                    const checkbox = document.getElementById(`person_${index}`);
                    const isSelected = window.savedSelectedPersons.includes(name);
                    checkbox.checked = isSelected;
                    if (isSelected) {
                        checkbox.parentElement.classList.add('selected');
                    } else {
                        checkbox.parentElement.classList.remove('selected');
                    }
                });
            }
        }

        // ì´ˆê¸°í™” (ìœ„íƒ + ì‚¬ì… ê°œìˆ˜ ì´ˆê¸°í™”, ë¶„ë°° ê²°ê³¼ëŠ” ìœ ì§€)
        function resetAll() {
            if (confirm('ìœ„íƒ/ì‚¬ì… ê°œìˆ˜ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ë¶„ë°° ê²°ê³¼ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) {
                products.forEach(p => {
                    p.stock = 0;
                    p.buyStock = 0;
                });
                renderProductTable();
                // ê°€ê²© ì •ë³´ëŠ” ìœ ì§€í•˜ê³  ì¬ê³ ë§Œ ì´ˆê¸°í™”í•˜ì—¬ ì €ì¥
                saveToLocalStorageSilent();
            }
        }

        // ë¶„ë°° ê²°ê³¼ ì´ˆê¸°í™” (ê²°ê³¼ ì„¹ì…˜ ìˆ¨ê¸°ê³  ì €ì¥ëœ ë¶„ë°° ë°ì´í„° ì‚­ì œ)
        function clearDistribution() {
            if (confirm('ë¶„ë°° ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('resultsGrid').innerHTML = '';
                document.getElementById('summary').innerHTML = '';
                document.getElementById('distributionTime').textContent = '';
                localStorage.removeItem('hyundaimall_distribution');
                localStorage.removeItem('hyundaimall_ordered');
            }
        }

        // ì¡°ìš©íˆ ì €ì¥ (ì•Œë¦¼ ì—†ì´)
        function saveToLocalStorageSilent() {
            products.forEach(p => updateProduct(p.id));
            const selectedPersons = getSelectedPersons();
            const data = {
                products: products.map(p => ({ id: p.id, price: p.price, stock: p.stock, buyStock: p.buyStock })),
                selectedPersons: selectedPersons
            };
            localStorage.setItem('hyundaimall_fair', JSON.stringify(data));
        }

        // ì¬ê³  ë°ì´í„° ë³µì‚¬ (ìœ„íƒ + ì‚¬ì… + ì„ íƒëœ ì¸ì›)
        function copyStockData() {
            products.forEach(p => updateProduct(p.id));

            // ì¬ê³ ê°€ 0ë³´ë‹¤ í° ìƒí’ˆë§Œ ë³µì‚¬ (ìœ„íƒ ë˜ëŠ” ì‚¬ì…)
            const dataLines = products
                .filter(p => p.stock > 0 || p.buyStock > 0)
                .map(p => `${p.name}\t${p.price}\t${p.stock}\t${p.buyStock}`)
                .join('\n');

            // ì„ íƒëœ ì¸ì› ëª©ë¡ ì¶”ê°€
            const selectedPersons = getSelectedPersons();
            const personsLine = `[ì„ íƒì¸ì›]\t${selectedPersons.join(',')}`;

            const fullData = dataLines + '\n' + personsLine;

            if (!dataLines) {
                alert('ë³µì‚¬í•  ì¬ê³  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            navigator.clipboard.writeText(fullData).then(() => {
                alert(`ì¬ê³  ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(ìœ„íƒ/ì‚¬ì… + ì„ íƒì¸ì› ${selectedPersons.length}ëª…)`);
            }).catch(err => {
                // í´ë¦½ë³´ë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì•ˆ
                const textArea = document.createElement('textarea');
                textArea.value = fullData;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert(`ì¬ê³  ë°ì´í„°ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n(ìœ„íƒ/ì‚¬ì… + ì„ íƒì¸ì› ${selectedPersons.length}ëª…)`);
            });
        }

        // ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ ì—´ê¸°
        function showPasteModal() {
            document.getElementById('pasteModal').style.display = 'flex';
            document.getElementById('pasteArea').value = '';
            document.getElementById('pasteArea').focus();
        }

        // ë¶™ì—¬ë„£ê¸° ëª¨ë‹¬ ë‹«ê¸°
        function closePasteModal() {
            document.getElementById('pasteModal').style.display = 'none';
        }

        // ë¶™ì—¬ë„£ì€ ë°ì´í„° ì ìš© (ìœ„íƒ + ì‚¬ì… + ì„ íƒëœ ì¸ì›)
        function applyPastedData() {
            const pasteArea = document.getElementById('pasteArea');
            const data = pasteArea.value.trim();

            if (!data) {
                alert('ë°ì´í„°ë¥¼ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');
                return;
            }

            const lines = data.split('\n');
            let appliedCount = 0;
            let personsApplied = false;

            lines.forEach(line => {
                const parts = line.split('\t');

                // ì„ íƒëœ ì¸ì› ë¼ì¸ ì²˜ë¦¬
                if (parts[0] === '[ì„ íƒì¸ì›]' && parts[1]) {
                    const selectedNames = parts[1].split(',').map(n => n.trim());
                    persons.forEach((name, index) => {
                        const checkbox = document.getElementById(`person_${index}`);
                        const isSelected = selectedNames.includes(name);
                        checkbox.checked = isSelected;
                        if (isSelected) {
                            checkbox.parentElement.classList.add('selected');
                        } else {
                            checkbox.parentElement.classList.remove('selected');
                        }
                    });
                    personsApplied = true;
                    return;
                }

                // ìƒí’ˆ ë°ì´í„° ì²˜ë¦¬ (ìœ„íƒ + ì‚¬ì…)
                if (parts.length >= 3) {
                    const name = parts[0].trim();
                    const price = parseInt(parts[1]) || 0;
                    const stock = parseInt(parts[2]) || 0;
                    const buyStock = parseInt(parts[3]) || 0; // ì‚¬ì… (4ë²ˆì§¸ ì»¬ëŸ¼)

                    const product = products.find(p => p.name === name);
                    if (product) {
                        product.price = price;
                        product.stock = stock;
                        product.buyStock = buyStock;
                        appliedCount++;
                    }
                }
            });

            if (appliedCount > 0 || personsApplied) {
                renderProductTable();
                closePasteModal();
                let msg = `${appliedCount}ê°œ ìƒí’ˆì˜ ì¬ê³  ë°ì´í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                if (personsApplied) {
                    msg += `\nì„ íƒëœ ì¸ì›ë„ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                }
                alert(msg);
            } else {
                alert('ì ìš©í•  ìˆ˜ ìˆëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\ní˜•ì‹: ìƒí’ˆëª…[íƒ­]ê°€ê²©[íƒ­]ìœ„íƒ[íƒ­]ì‚¬ì…');
            }
        }

        // ì£¼ë¬¸ ì™„ë£Œ í† ê¸€
        function toggleOrder(personIndex, itemId) {
            const checkbox = document.getElementById(itemId);
            const li = document.getElementById(itemId + '_li');
            const card = document.getElementById(`card_${personIndex}`);
            const badge = document.getElementById(`badge_${personIndex}`);
            const itemCount = parseInt(card.dataset.itemCount);

            if (li.classList.contains('ordered')) {
                li.classList.remove('ordered');
                checkbox.innerHTML = '';
            } else {
                li.classList.add('ordered');
                checkbox.innerHTML = 'âœ“';
            }

            // ì²´í¬ëœ ê°œìˆ˜ ê³„ì‚°
            const checkedCount = card.querySelectorAll('li.ordered').length;

            // ë±ƒì§€ ì—…ë°ì´íŠ¸
            if (checkedCount === itemCount) {
                badge.textContent = 'ì™„ë£Œ!';
                badge.classList.add('done');
                card.classList.add('completed');
            } else {
                badge.textContent = `${checkedCount}/${itemCount}`;
                badge.classList.remove('done');
                card.classList.remove('completed');
            }

            // ì²´í¬ ìƒíƒœ ì €ì¥
            saveOrderStatus();
        }

        // ë¶„ë°° ê²°ê³¼ ì €ì¥
        function saveDistributionResults(results, stockRemaining, buyAssignments = {}) {
            const now = new Date();
            const timeString = formatDistributionTime(now);
            const data = {
                results: results.map(r => ({
                    personName: r.personName,
                    items: r.items,
                    total: r.total,
                    tier: r.tier
                })),
                stockRemaining: stockRemaining,
                buyAssignments: buyAssignments,
                savedAt: now.toISOString(),
                timeString: timeString
            };
            localStorage.setItem('hyundaimall_distribution', JSON.stringify(data));

            // ì‹¤í–‰ ì‹œê°„ í‘œì‹œ
            document.getElementById('distributionTime').textContent = `(${timeString} ì‹¤í–‰)`;
        }

        // ë¶„ë°° ì‹œê°„ í¬ë§·
        function formatDistributionTime(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hours = date.getHours();
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const ampm = hours < 12 ? 'ì˜¤ì „' : 'ì˜¤í›„';
            const hour12 = hours % 12 || 12;
            return `${month}/${day} ${ampm} ${hour12}:${minutes}`;
        }

        // ì£¼ë¬¸ ì²´í¬ ìƒíƒœ ì €ì¥
        function saveOrderStatus() {
            const orderedItems = [];
            document.querySelectorAll('li.ordered').forEach(li => {
                orderedItems.push(li.id);
            });
            localStorage.setItem('hyundaimall_ordered', JSON.stringify(orderedItems));
        }

        // ì €ì¥ëœ ë¶„ë°° ê²°ê³¼ ë³µì›
        function restoreDistributionResults() {
            const savedData = localStorage.getItem('hyundaimall_distribution');
            const savedOrdered = localStorage.getItem('hyundaimall_ordered');

            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    const orderedItems = savedOrdered ? JSON.parse(savedOrdered) : [];

                    displayResults(data.results, data.stockRemaining, data.buyAssignments || {});

                    // ì‹¤í–‰ ì‹œê°„ ë³µì›
                    if (data.timeString) {
                        document.getElementById('distributionTime').textContent = `(${data.timeString} ì‹¤í–‰)`;
                    } else if (data.savedAt) {
                        // ì´ì „ í˜•ì‹ í˜¸í™˜ (savedAtë§Œ ìˆëŠ” ê²½ìš°)
                        const savedDate = new Date(data.savedAt);
                        document.getElementById('distributionTime').textContent = `(${formatDistributionTime(savedDate)} ì‹¤í–‰)`;
                    }

                    // ì²´í¬ ìƒíƒœ ë³µì›
                    setTimeout(() => {
                        orderedItems.forEach(liId => {
                            const li = document.getElementById(liId);
                            if (li) {
                                li.classList.add('ordered');
                                const checkbox = li.querySelector('.order-check');
                                if (checkbox) checkbox.innerHTML = 'âœ“';
                            }
                        });

                        // ë±ƒì§€ ì—…ë°ì´íŠ¸
                        document.querySelectorAll('.person-card').forEach(card => {
                            const personIndex = card.id.replace('card_', '');
                            const badge = document.getElementById(`badge_${personIndex}`);
                            const itemCount = parseInt(card.dataset.itemCount);
                            const checkedCount = card.querySelectorAll('li.ordered').length;

                            if (checkedCount === itemCount) {
                                badge.textContent = 'ì™„ë£Œ!';
                                badge.classList.add('done');
                                card.classList.add('completed');
                            } else {
                                badge.textContent = `${checkedCount}/${itemCount}`;
                            }
                        });
                    }, 100);
                } catch (e) {
                    console.error('ë¶„ë°° ê²°ê³¼ ë³µì› ì‹¤íŒ¨:', e);
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        init();
        restoreDistributionResults();
    </script>
</body>
</html>
